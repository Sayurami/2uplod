<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gojo Photo Gallery</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; background: #f5f5f5; padding: 20px; }
  h1 { margin-top: 20px; }
  form { margin: 20px auto; display: flex; flex-direction: column; align-items: center; gap: 10px; }
  .gallery { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 20px; }
  .gallery-item { width: 200px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fff; }
  .gallery-item img { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; cursor: pointer; }
  .gallery-item h3, .gallery-item p { margin: 5px 0; word-break: break-word; }
  .gallery-item button { margin-top: 5px; padding: 5px 10px; cursor: pointer; }
  #loginBox { margin: 20px auto; display: none; flex-direction: column; align-items: center; gap: 10px; width: 250px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 0 5px #aaa; }
</style>
</head>
<body>

<h1>üì∏ Gojo Photo Gallery</h1>

<!-- Upload form (everyone can use) -->
<form id="uploadForm" enctype="multipart/form-data">
  <input type="file" name="photo" accept="image/*" required />
  <input type="text" name="name" placeholder="Photo Name" required />
  <textarea name="description" placeholder="Photo Description (support links)" rows="2" required></textarea>
  <button type="submit">Upload</button>
</form>

<!-- Login Box (only for admin) -->
<div id="loginBox">
  <h3>üîë Admin Login</h3>
  <input type="text" id="username" placeholder="Username" />
  <input type="password" id="password" placeholder="Password" />
  <button onclick="login()">Login</button>
</div>

<!-- Login button visible under gallery -->
<button id="loginToggle">Admin Login</button>

<div class="gallery" id="gallery"></div>

<script>
const form = document.getElementById('uploadForm');
const gallery = document.getElementById('gallery');
const loginBox = document.getElementById('loginBox');
const loginToggle = document.getElementById('loginToggle');

let isAdmin = false; // default not logged in

// üîë Hard-coded admin credentials (frontend)
const ADMIN_USER = "sayura";
const ADMIN_PASS = "Sayura2008***7";

// Convert links in text
function linkify(text) {
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  return text.replace(urlRegex, url => `<a href="${url}" target="_blank">${url}</a>`);
}

// Load gallery from backend
async function loadGallery() {
  const res = await fetch('/uploads/');
  const items = await res.json();
  gallery.innerHTML = '';
  items.forEach(item => {
    const div = document.createElement('div');
    div.className = 'gallery-item';
    div.innerHTML = `
      <img src="/file/${item.id}" onclick="window.open('/file/${item.id}', '_blank')" />
      <h3>${item.name}</h3>
      <p>${linkify(item.description)}</p>
      <button onclick="downloadPhoto('/file/${item.id}')">Download</button>
      ${isAdmin ? `<button onclick="deletePhoto('${item.id}')">Delete</button>` : ""}
    `;
    gallery.appendChild(div);
  });
}

// Download photo
function downloadPhoto(url) {
  const link = document.createElement('a');
  link.href = url;
  link.download = url.split('/').pop();
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Delete photo (admin only)
async function deletePhoto(fileId) {
  if (!confirm('Are you sure you want to delete this photo?')) return;
  const res = await fetch('/uploads/' + fileId, { 
    method: 'DELETE',
    headers: {
      "Authorization": "Basic " + btoa(ADMIN_USER + ":" + ADMIN_PASS)
    }
  });
  const data = await res.json();
  if (data.success) loadGallery();
  else alert('Delete failed: ' + (data.error || ""));
}

// Upload new photo
form.addEventListener('submit', async e => {
  e.preventDefault();
  const formData = new FormData(form);
  const response = await fetch('/upload', { method: 'POST', body: formData });
  const data = await response.json();
  if (data.success) {
    await loadGallery();
    form.reset();
  } else {
    alert('Upload failed');
  }
});

// Toggle login box
loginToggle.addEventListener('click', () => {
  loginBox.style.display = loginBox.style.display === 'flex' ? 'none' : 'flex';
});

// Admin login (frontend only)
function login() {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;

  if (username === ADMIN_USER && password === ADMIN_PASS) {
    isAdmin = true;
    loginBox.style.display = 'none';
    alert('‚úÖ Admin logged in!');
    loadGallery();
  } else {
    alert('‚ùå Wrong username or password');
  }
}

// Initial load
loadGallery();
</script>

</body>
</html>